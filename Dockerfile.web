FROM python:3.10
RUN apt-get -y update && \
    apt-get -y upgrade && \
    apt-get install -y ffmpeg && \
    curl -fsSL https://deb.nodesource.com/setup_lts.x | bash - && \
    apt-get install -y nodejs
RUN mkdir -p /src
ADD . /src
WORKDIR /src
RUN pip install -r requirements.txt
RUN npm --prefix app install && NODE_ENV=production npm --prefix app run build && mv app/build .
CMD alembic upgrade head
ENTRYPOINT gunicorn server.app:app -w 2 -k uvicorn.workers.UvicornWorker -b :8080 -c config.py